# 领域驱动开发说明




领域驱动开发说明

<!--more-->



# SinfCloud-领域驱动开发说明

CreateBy lln

CreateTime 2023-06-26

UpdateTime 2023-07-03

------

文章内容说明：

​	本文以不动产登记系统-档案管理子系统为例，分别进行与框架默认结构的对比和改造流程、单体微服务结构说明、服务间调用说明、代码包拆分说明、代码层级调用链说明，用于描述领域驱动在项目中落地的整体流程，以供设计人员、开发人员参考。

关键字：【领域驱动设计】【框架改造】【代码结构】

## 一、基于领域驱动的代码结构说明

## 1.1 单系统（微服务）结构说明

​	下图为单个微服务的整体结构，描述了消费者和提供者的整体关系、消费者、提供者内部结构、代码包结构的情况。详细说明如下。

<img src=".\md截图\领域驱动落地-示意图-单体微服务结构图.drawio.png" alt="领域驱动落地-示意图-单体微服务结构图.drawio" style="zoom:%;" />



### 1.1.1 消费者结构说明

​	【代码结构】消费者层，controller层负责当前微服务对外（指所有WEB端、移动端）提供接口，entitydto层负责处理外部接口调用后的数据转换和业务调用，拆解为多个不同的提供者实体（entitydo层），拆解后，调用不同的提供者服务（api层），向不同的提供者分发业务逻辑。

<img src=".\md截图\领域驱动落地-示意图-层级调用链-消费者.drawio.png"/>

### 1.1.2 提供者结构说明

​	1、【整体架构-提供者版本控制】每个提供者内部通过划分版本包结构的方式，进行不同版本如V1_0、V2_0的划分。版本内部结构完全一致，如需更新应用版本时，将需要更新版本的相关代码进行拷贝复制至新版本包中，并更新接口层中的版本符号，完成后续应用接口开发和更新操作。

​	2、【代码结构-接口层】infrastructure层中，controller包提供接口信息，包含所有的当前REST接口信息，并调用应用服务层(service层)中的方法进行业务处理；api层记录调用的其他提供者的RPC信息；

dto层存储对接其他提供者服务的数据模型；convertor层处理对接其他提供者服务时的数据映射和转换。

​	3、【代码结构-应用层】event层，负责触发和监听领域消息，根据实际业务场景，对不同聚合中的领域事件服务（Domain-service）进行业务层面的组装；组装业务后，由应用服务层（Application-service）进行统一调用，service层由接口层中的controller进行调用。service往往与controller提供的接口一一对应。

​	4、【代码结构-领域层】entitydo领域事件层，调用entitypo（持久化对象层）进行CRUD操作,获取结果处理所有当前领域相关的业务逻辑，；entitypo（持久化对象层）只用于接收参数，组装SQL查询并返回结果，不处理任何逻辑。model层（数据库实体映射）存放entity（实体映射层，贫血对象）作为数据数据库表的一对一映射，ex（实体扩展）只用于处理非库表结构的字段增加和补充，不做业务逻辑处理和数据校验。service（领域服务层）调用组装各个领域事件（entitydo），组装各个领域的业务逻辑，最终完成整个领域服务业务逻辑，供应用层（Application-event）进行组装调用。

​	5、【代码结构-基础层】infrastructure层严格意义上来说并不处于最下面一层。在上面三层中，所有的外部依赖（DB、缓存、中间件、服务调用）都使用接口的方式来避免和具体技术耦合。基础层提供了这些接口的具体实现，需要保障依赖关系不能倒置，即：除了基础层不能有对外部依赖的具体实现。

<img src=".\md截图\领域驱动落地-示意图-层级调用链-提供者.drawio.png"/>



### 1.1.3 总调用链

​	下图为整体业务流程的调用链说明。

<img src=".\md截图\领域驱动落地-示意图-层级调用链-总体.drawio.png"/>



## 1.2 微服务间调用示意图

​	接口层（Interfaces）中的controller提供REST接口；api层进行RPC调用；需要适配的其他提供者实体模型，放入dto层存储，通过convertor层进行实体对象之间的转换。

​	应用服务（Application-service）之间的数据传递，通过基础层提供的中间件服务，如Redis、RabbtiMq等组件进行调用。

​	下图为微服务的间调用的关系图，描述了领域驱动架构中，微服务调用的关系。



<img src=".\md截图\领域驱动落地-示意图-领域驱动-微服务间调用示意图.drawio.png"/>



## 1.3 包结构说明

​	下面基于不动产登记系统-档案管理子系统的领域设计，生成的基于领域驱动的代码结构，具体如下图。

### 1.3.1 消费者结构

​	下图为档案系统的消费者结构说明和代码层级图

```
|-- ./v1_0
    |-- ./api		    接口防腐层，定义了provider(生产者)的PRC调用信息
    |-- ./controller	web对外接口控制层
    |-- ./entitydo		领域对象，可以拆分为多个po（实体）对象
    |-- ./entitydto		数据传输对象，可以拆分为多个do（领域对象）
```

<img src=".\md截图\image-20230703155333441.png" alt="image-20230703155333441" style="zoom: 50%;" />

### 1.3.2 提供者结构

​	下图为档案系统的提供者结构说明和代码层级图，与1.1 单系统（微服务）结构说明中的示意图对应。

```
|-- ./v1_0								版本v1_0
|   |-- ./v1_0/app							应用层
|   |   |-- ./v1_0/app/event					组装领域事件
|   |   `-- ./v1_0/app/service				     应用服务
|   |-- ./v1_0/domain						领域对象层，包含多个业务聚合
|   |   |-- ./v1_0/domain/dabhgz				聚合：档案编号规则
|   |   |-- ./v1_0/domain/darq					聚合：档案容器
|   |   |-- ./v1_0/domain/dayjjl				聚合：档案移交记录
|   |   |-- ./v1_0/domain/dzjbxx				聚合：档案基本信息
|   |-- ./v1_0/infrastructure				基础支持层
|   |   `-- ./v1_0/infrastructure/util		 	公共工具层
|   `-- ./v1_0/interfaces					接口层
|       |-- ./v1_0/interfaces/api			 	接口防腐层(内部)
|       |-- ./v1_0/interfaces/controller	  	出入参转换器
|       |-- ./v1_0/interfaces/convertor		  	提供者对外接口层
|       |-- ./v1_0/interfaces/dto			 	数据传输模型

`-- ./v2_0								版本v2_0
	...
`-- ./v3_0								版本v3_0
	...		
```

​	整体包结构图

<img src=".\md截图\image-20230703165656764.png" alt="image-20230703165656764" style="zoom: 50%;" />



​	包结构展开说明图

<img src=".\md截图\image-20230703163226011.png" alt="image-20230703163226011" style="zoom: 50%;" />



​	领域层包对象拆分逻辑，在目录2.2.2提供者改造方案中有详细描述。

### 1.3.3 代码版本控制说明

​	在系统开发中，往往会随着业务需求的变化，对已有代码进行升级和迭代，形成两个类型的代码版本。

​	API版本说明：

​	将不同时期变化的代码，称之为“API版本”。API版本通过在消费者、提供者跟目录下，拆分新的代码包，如V1_0,V2_0等等进行管理,同时将相关的API的URL地址进行修改，从V1_0修改为V2_0。

​	区域版本说明：

​	如有某个地市级系统的业务，有区别于省级系统的定制化的专属需求，将不同地域的定制化版本，称之为“区域版本”。区域版本的控制，通过抽取公共开放代码，迁移至扩展开放版本中，将开放版本通过依赖引入至具体的某个区域定制版本中作为基础模块使用。具体设计内容参考《不动产登记云平台版本化管理及开发规范v1.0》的说明。（https://docs.qq.com/doc/DRFlqWEdqdnNRclpE）。

​	为了更好的维护不同时期的代码版本、不同地域的代码版本，在代码架构中，使用如下图所示的方案，进行代码版本划分。

​	

<img src=".\md截图\领域驱动落地-示意图-代码版本控制示意图.drawio.png" />

## 二、与框架默认结构的对比和改造方案

​	与SinfCloud框架的默认生成结构相比，需要进行一些改变和重构，在不改变SinfCloud的原有框架设计的情况下，则需要对原有代码结构更进一步的进行软件包的拆分，才能够体现在领域驱动设计中的四层模型概念，也能与每个系统的领域驱动设计文档有所关联和映射。下面对提供者和消费者分别进行说明。

### 2.1 消费者

#### 2.1.1 消费者改造

​	与原结构相比，修改后的结构，去除了generate的包分类。按照领域驱动中，接口层的拆分规范进行包结构定义。

<img src=".\.\image-20230703172429754.png" />

#### 2.1.2 消费者总体结构对比

<img src=".\md截图\领域驱动落地-示意图-消费者结构对比图.drawio.png" alt="领域驱动落地-示意图-消费者结构对比图.drawio" style="zoom: 67%;" />





### 2.2 提供者

#### 2.2.1 提供者改造

​	提供者的改造基于领域驱动中的四层模型进行包结构的拆分。如图所示：

<img src=".\.\md截图\领域驱动落地-示意图-第 10 页.drawio.png" />

​	提供者中Domain层的聚合，基于领域设计中的聚合分析进行包结构的拆分，如图所示：

<img src=".\.\md截图\【领域驱动设计】不动产登记档案管理系统V2.8.1drawio-第 14 页.drawio.png" />

​	修改内容为：

​	1、基于领域四层模型创建代码包。

​	2、基于领域设计中的聚合分析，对框架默认包进行移动和重构。内容如下：

​		2.1、将默认结构中，【entity】中的所有Ex类，移动至【domain】-【业务聚合包】-【po】-【ex】包中。需要基于设计来定义Ex所对应的聚合。

​		2.2、将默认结构中，【entitydo】中的所有Do类，移动至【domain】-【业务聚合包】-【entitydo】包中。需要基于设计来定义Do类所对应的聚合。

​		2.3、将默认结构中，【generate】-【controller】包中所有的Controller类，移动至【interfaces】-【controller】包中。

​		2.4、将默认结构中，【generate】-【entity】包中所有的Po类，移动至【domain】-【业务聚合包】-【po】包中。需要基于设计来定义Po类所对应的聚合。

​		2.5、将默认结构中，【generate】-【entity】包中所有的entity实体类，移动至【domain】-【业务聚合包】-【model】包中。需要基于设计来定义entity实体类所对应的聚合。

如2.2.2 中结构对比图所示。

#### 2.2.2 提供者总体结构对比

​	原有代码结构如图所示

<img src=".\md截图\领域驱动落地-示意图-提供者结构对比图.drawio.png" alt="领域驱动落地-示意图-提供者结构对比图.drawio" style="zoom: 67%;" />



### 2.3 改造遇到的问题

​	1、需要移动和重构的代码比较多，手动重构的话很容器有遗漏，或没有按照领域驱动设计图的聚合进行移动。但是代码生成器也无法按照领域设计进行代码生成。这块需要思考如何减少工作量。

​	2、改造后的结构去除了默认生成的generate包结构，将其中的代码进行了拆分，是否需要保留generate这部分的设计，需要思考。

​	3、领域驱动下的业务调用链比较长，如何在开发中进行规范话的管控，避免开发人员将所有逻辑堆砌到上层，将结果进行数据透传的为了DDD而DDD的错误操作，需要思考。

## 三、开发注意事项

​	1、使用IDEA进行开发时，需统一安装 Alibaba 代码质量检测插件 【Alibaba Java Coding Guidelines】

​	2、尽量避免和处理编译器层面的Warnning警告提示

​	3、尽量不要使用JsonObject或者Map进行数据透传

​	4、在Ex层不要处理业务逻辑和SQL

​	5、具体编码细节参考OA文档中的开发规范

## 参考内容

关于DDD的认知
https://www.bilibili.com/video/BV1Ns4y197WD/?spm_id_from=333.337.search-card.all.click&vd_source=93189541b207f6eb4c8a443ffe4140e7

https://mp.weixin.qq.com/s/g2k9LhmNwuBJ9h00fxul1w

阿里COLA框架地址

https://github.com/alibaba/COLA

COLA架构的结构分析
https://blog.csdn.net/significantfrank/article/details/110934799

COLA项目实践
https://baijiahao.baidu.com/s?id=1717604031061047078&wfr=spider&for=pc

SinfCloud的设计概念

https://note.youdao.com/s/XdBavsxl

关于贫血模型和充血模型

https://blog.csdn.net/m0_51358164/article/details/125744851


