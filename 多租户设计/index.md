# 多租户设计记录


<!--more-->
多租户对于用户来说，最主要的一点就在于数据隔离，不可以说，我登了A用户的号，但是看到了B用户的数据。

常见的大概就四种：
## 方案一： 单数据源单数据库单数据表

所有租户使用同一数据源下同一数据库下共同数据表，在每一个数据表中增加一列租户ID，用以区分租户的数据。增删查改时，一定要带上租户ID，否则就会操作到其他租户的数据
典型的解决方案就是通过AOP，隐式的为我们的每一个SQL带上这个租户ID。
而在orm框架如mybatis中，可以拦截器插件进行SQL层面的拦截拼接，而MyBatis-Plus高版本则提供了更加方便的拦截器，并且已经将多租户插件放入JAR包，将该插件加入到MyBatis的拦截器链中，就可以不用再显式的拼接租户ID字段

优缺点：
该方案成本最低，安全性也是最低，所有数据都放在一起，单个租户的数据恢复和备份会很复杂。
比如，有ABC三个租户共同使用，当C租户已经确定以后不再使用了，他的数据也不好从数据库中剔除。如果某一数据出现了问题，也不便于租户问题的排查。
这就得保证对开发者的严苛要求，最主要还是增加了对数据的管理复杂度。尤其注意，尽量不要去手动显式的设置租户ID到SQL，否则一旦出现问题，纠正是很复杂的
## 方案二：单数据源单数据库多数据表
所有租户使用同一数据源下同一数据库下不同数据表
比如租户A的用户表叫user_001，用户B的用户表叫user_002
数据库难以实现连表查询，只能进行多次单表查询，对事务的控制基本为0。
一般来说，对于小场景而言，这种架构的设计已经完全够用了
新建租户时需要建表，每次建表，都要使用DDL建新租户所使用的所有表。

优缺点：
该方案提供了一定的数据隔离，但不是完全的隔离，由于数据库是共享的，所以成本也不是很高。

## 方案三：单数据源多数据库多数据表

所有租户使用同一数据源下不同数据库下不同数据表
将租户数据彻底隔离，给每个租户创建一个数据库
基本上和方案二类似
在完成数据表的创建后，然后就是具体的增删改查问题。还是可以使用MyBatis插件，动态的改造表名，在表名前拼接上数据库名，具体的实现也是非常简单，直接拿方案二稍微改改即可。
使用这种单数据源方案可以轻松实现跨数据库执行SQL和事务执行。

优缺点：
该方案其实和方案二大同小异，对单数据源来说，都不是彻底的隔离。成本和方案二差不多。

## 方案四：单数据源多数据库多数据表

所有租户使用不同数据源下不同数据库下不同数据表
在单数据源中，跨数据库操作和数据库事务是已经被支持的。
但是在多数据源中，传统的跨库操作和数据库事务已经难以适用，甚至有时候会出现动态的新增租户，并且租户数据源动态配置等问题。
这时，光靠简单的几百行代码已经无法实现。以下是几个方案来：
- 使用AOP加注解动态切换数据源
- 使用MyBatis插件切换数据源（可以比较方便的判断SQL类型，区分读写操作）
- 多个MyBatis配置来引入多个数据源（比较占内存）
这种多数据源方案，目前也有一些开源项目实现了这一方案。就是为不同的租户提供独立的数据库，数据库由租户自己购买，或商家购买，然后配置到系统中，满足不同租户的独特需求，如果出现故障，数据恢复也比较简单。

优缺点：
这种方案增加了数据库的安装数量，单个数据库的资源利用率就不高了，而且数据库的数量一多，成本就高了，安全性的代价就是成本。还要考虑到多数据库的事务问题，多数据库的数据源切换问题，这代码复杂度和成本就上来了，相当费钱



